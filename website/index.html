<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Inter-rater Reliability</title>
		<script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
		<script type="text/javascript" src="js/bootstrap.min.js"></script>
		<script type="text/javascript" src="js/d3.v3.js"></script>
		<script type="text/javascript" src="js/colorbrewer.js"></script>
		<script type="text/javascript" src="js/underscore.js"></script>
		<script type="text/javascript" src="js/backbone.js"></script>
		<script type="text/javascript" src="js/spin.min.js"></script>
		<script type="text/javascript" src="js/spin_helper.js"></script>
		<!-- app -->
		<script type="text/javascript" src="js/bb_hack.js"></script>
		<script type="text/javascript" src="js/app/models.js"></script>
		<script type="text/javascript" src="js/app/overall_views.js"></script>
		<script type="text/javascript" src="js/app/user_views.js"></script>
		<script type="text/javascript" src="js/app/code_views.js"></script>
		<script type="text/javascript" src="js/app/main_views.js"></script>
		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript" src="js/app/router.js"></script>

		<!-- css -->
		<link href="css/bootstrap.css" rel="stylesheet" type="text/css">
		<link href="css/colorbrewer.css" rel="stylesheet" type="text/css">
		<link href="css/default.css" rel="stylesheet" type="text/css">


		<style type="text/css">
		</style>
		<script>
			var sessionSVG = null;
			var selectedYear = 2004, isSelectingDate = false;

			//
			//
			//
			//
			//
			function transformPairs(data) {
				res = { data: {}, extra: {} };
				var timerange = [Number.MAX_VALUE, Number.MIN_VALUE];
				var range = [Number.MAX_VALUE, Number.MIN_VALUE];
				var bins = {};
				var histogram = {};
				var pair_data = {};
				var point_details = {};

				var overall_sum = 0;
				var overall_cnt = 0;


				data.forEach(function(d,i){
					var point_sum = 0;
					var point_cnt = 0;
					var linenum = 0;
					for(var pair in d3.values(possible_pairs)) {
						var pair_name = possible_pairs[pair];
						var value = d[pair_name];

						linenum = +d.id;

						timerange[0] = Math.min(timerange[0],Date.parse(d.time));
						timerange[1] = Math.max(timerange[1],Date.parse(d.time));
						range[0] = Math.min(range[0], linenum);
						range[1] = Math.max(range[1], linenum);
						if(pair_name in d && value != undefined && value != null && value != "") {
							if(!(linenum in bins)) {
								bins[linenum] = {};
							}
							bins[linenum][pair_name] = +value;

							// point data
							point_cnt++;
							point_sum += +value;

							// pair data
							if(!(pair_name in pair_data)) {
								pair_data[pair_name] = {
									cnt: 0,
									sum: 0,
									avg: 0,
									stddev: 0
								}
							}

							pair_data[pair_name].cnt++;
							pair_data[pair_name].sum+= +value;

							// check if our data is in the pair already
							if(!(pair_name in res.data)){
								res.data[pair_name] = {}
							}

							//res[pair_name][d.time] = d[pair_name];
							res.data[pair_name][linenum] = d[pair_name];

							// histogram
							if( !(value in histogram)) {
								histogram[value] = 0;
							}
							histogram[value]++;

							overall_sum += +value;
							overall_cnt++;

						}
					}

					var point_avg = point_sum/point_cnt;
					var point_var = 0;
					for(var pair in d3.values(possible_pairs)) {
						var pair_name = possible_pairs[pair];
						var value = d[pair_name];
						if(pair_name in d && value != undefined && value != null && value != "") {
							var diff = value - point_avg;
							point_var += diff * diff;
						}
					}
					var point_sd = Math.sqrt(point_var);

					point_details[linenum] = {
						sum: point_sum,
						cnt: point_cnt,
						avg: point_avg,
						ssq: point_var,
						sd: point_sd
					}

				});

				res.extra['timerange'] = timerange;
				res.extra['range'] = range;
				res.extra['histogram'] = histogram;
				res.extra['overall'] = { avg: (overall_sum / overall_cnt), sum: overall_sum, cnt: overall_cnt, ssq: 0, sd: 0};
				res.extra['pair_data'] = pair_data;
				res.extra['point_data'] = point_details;

				console.log("after transform");
				console.dir(res);
				console.log('bins');
				console.dir(bins);
				console.dir(histogram);
				console.log('overall_sum: ' + overall_sum);
				console.log('overall_cnt: ' + overall_cnt);
				console.log('overall average: ' + (overall_sum / overall_cnt));
				return res;
			}




			/*
			 * 1. First find all unique line ids in the data
			 * 2. Aggregate all agreement values in that dataset
			 * 3. Caclulate Mean, stddev
			 * 4. Calculate appropriate UB/LB confidence intervals
			 *
			 *
			 *
			 *
			 */
			function processSessionData(data) {
				bins = {}



			}



			//
			// ready
			//
			$(document).ready(function() {  

				format = d3.time.format("%Y-%m-%d %H:%M:%S");
				dayFormat = d3.time.format("%Y-%m-%d");

				var spinner = $('body').spin("small");

				d3.csv("data/15line.csv", function(csv) {
					console.log('got csv!');
					console.dir(csv);
					data = csv;

					dataMap = d3.nest()
						.key(function(d){
							return ((new Date(format.parse(d.time))).getYear() + 1900);
						})
						.key(function(d){ 
						fulldate = new Date(format.parse(d.time));
						date = new Date(fulldate.getYear() + 1900, fulldate.getMonth(), fulldate.getDate())
							return dayFormat(date); 
						})
						.entries(data);

					console.log("dataMap");
					console.dir(dataMap);

					//dataMap = dataMap.map();

					console.dir(d3.keys(dataMap));

					// grab our possible pairs
					possible_pairs = Object.keys(csv[0]);
					possible_pairs = possible_pairs.filter(function(d){
						return (d.indexOf('-') != -1);
					});
					console.dir(possible_pairs);


					// router
					router = new IRA.IRAApp();

					// 
					spinner.spin(false);

				});

			});
		</script>

	</head>
	<body>
		<div class="container-fluid">
			<div class="row-fluid">
				<legend>Inter-rater Reliability</legend>
			</div>

			<div class="row-fluid">
				<div class="btn-group" data-toggle="buttons-radio" id="mode-select">
  					<button type="button" class="btn btn-primary active" data-mode="0">All</button>
  					<button type="button" class="btn btn-primary" data-mode="1">Users</button>
  					<button type="button" class="btn btn-primary" data-mode="2">Codes</button>
				</div>
			</div>
			<div id="main-view" class="row-fluid"></div>
			<div id="sub-view" class="row-fluid"></div>
		</div>        
	</body>

	<script type="text/template" id="templ-main">
		<div class="row-fluid">
			<div id="yearselect">
				<ul class="nav nav-pills"></ul>
			</div>
			<div id="sessions" class="span10"></div>              
		</div>	
		<div id="graph" class=""></div>
		<div id="sidepanel" class="scrolllist">
			<h4>Frequencies</h4>
			<div id="sp-histogram"></div>
			<h4>Details</h4>
			<div id="sp-details"></div>
			<h4>Coders</h4>
			<div class="scrolllist" id="sp-coderlist">
				<div id="coder-list-header" class="coder-line">
					<div><i class="icon-eye-close"></i></div>
					<div><i class="icon-star"></i></div>
					<div>#</div>
					<div>Mean</div>
				</div>
				<ul id="sp-coders">
				</ul>
			</div>
		</div>	
	</script>
	<script type="text/template" id="templ-users">
		<div id="graph" class=""></div>
		<div id="sidepanel" class="scrolllist">
			<h4>Details</h4>
			<div id="sp-details"></div>
			<h4>Coders</h4>
			<div class="scrolllist">
				<div id="coder-list-header" class="coder-line">
					<div><i class="icon-eye-close"></i></div>
					<div><i class="icon-star"></i></div>
					<div>#</div>
					<div>Mean</div>
				</div>
				<ul id="sp-coders">
				</ul>
			</div>
		</div>	
	</script>
	<script type="text/template" id="templ-codes">
		<div id="graph" class=""></div>
		<div id="sidepanel" class="scrolllist">
			<h4>Details</h4>
			<div id="sp-details"></div>
			<h4>Codes</h4>
			<div class="scrolllist">
				<div id="code-list-header" class="code-line">
					<div><i class="icon-eye-close"></i></div>
					<div><i class="icon-star"></i></div>
					<div>#</div>
					<div>Mean</div>
				</div>
				<ul id="sp-codes">
				</ul>
			</div>
		</div>	
	</script>
	<script type="text/template" id="templ-layerlist">
		<div class="layer-item layer-header">
			<div><i class="icon-eye-close"></i></div>
			<div><i class="icon-star"></i></div>
			<div>#</div>
			<div>Mean</div>
		</div>
		<ul class="layerlist-body">
		</ul>

	</script>
	<script type="text/template" id="templ-layerlistitem">
		<div class="vis-toggle"><% if(visible) { %><i class="icon-eye-open"></i><% } else { %><i class="icon-eye-close ll-unselected"></i><% } %></div>
		<div class="spotlight-toggle"><% if(spotlight) { %><i class="icon-star"></i><% } else { %><i class="icon-star-empty ll-unselected"></i><% } %></div>
		<div><%= name %></div>
		<div><%= details %></div>
	</script>
</html>